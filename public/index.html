<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Steam Key 价格监控</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  </head>
  <body>
    <!-- 顶部导航栏 -->
    <nav class="navbar">
      <div class="navbar-brand">
        <span class="navbar-logo">Steam</span>
        <span class="navbar-title">Steam Key 价格监控</span>
      </div>
      <!-- 移动端游戏选择器 -->
      <select
        id="mobile-game-select"
        class="mobile-game-select"
        onchange="selectGameMobile(this.value)"
      >
        <option value="">选择游戏...</option>
      </select>
      <div class="navbar-actions">
        <button id="btn-refresh" class="btn" onclick="refreshData()">
          刷新
        </button>
        <button
          id="btn-collect"
          class="btn btn-success"
          onclick="manualCollect()"
        >
          采集
        </button>
        <button id="btn-theme" class="btn" onclick="toggleTheme()">主题</button>
        <button class="btn btn-primary" onclick="showSettingsModal()">
          设置
        </button>
      </div>
    </nav>

    <!-- 主体内容 -->
    <div class="main-wrapper">
      <!-- 侧边栏 -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <h3>监控游戏</h3>
          <button class="btn btn-sm" onclick="showAddGameModal()">
            + 添加
          </button>
        </div>
        <div class="game-list" id="game-list">
          <!-- 动态生成 -->
        </div>
      </aside>

      <!-- 主内容区 -->
      <main class="content">
        <!-- 页面标题 -->
        <div class="page-header">
          <div>
            <h1 class="page-title" id="current-game-title">价格监控</h1>
            <p class="page-subtitle">
              最后更新：<span id="last-update">--</span>
            </p>
          </div>
        </div>

        <!-- 时间维度选择 -->
        <div class="card">
          <div class="period-selector">
            <span>时间范围：</span>
            <button class="period-btn active" data-period="day">
              最近24小时
            </button>
            <button class="period-btn" data-period="week">最近7天</button>
            <button class="period-btn" data-period="month">最近30天</button>
            <button class="period-btn" data-period="all">全部数据</button>
          </div>
        </div>

        <!-- 统计卡片 -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">价</div>
            <div class="stat-content">
              <div class="stat-value" id="stat-current">--</div>
              <div class="stat-label">当前最低价</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">低</div>
            <div class="stat-content">
              <div class="stat-value" id="stat-lowest">--</div>
              <div class="stat-label">历史最低价</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">均</div>
            <div class="stat-content">
              <div class="stat-value" id="stat-avg">--</div>
              <div class="stat-label">平均最低价</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">高</div>
            <div class="stat-content">
              <div class="stat-value" id="stat-highest">--</div>
              <div class="stat-label">最高最低价</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">卖</div>
            <div class="stat-content">
              <div class="stat-value" id="stat-sellers">--</div>
              <div class="stat-label">当前卖家数</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">库</div>
            <div class="stat-content">
              <div class="stat-value" id="stat-stock">--</div>
              <div class="stat-label">当前库存</div>
            </div>
          </div>
        </div>

        <!-- 价格走势图 -->
        <div class="card chart-card">
          <div class="card-header">
            <h3>价格走势</h3>
            <div class="chart-legend">
              <span class="legend-item"
                ><span class="dot min"></span>最低价</span
              >
              <span class="legend-item"
                ><span class="dot avg"></span>平均价</span
              >
              <span class="legend-item"
                ><span class="dot max"></span>最高价</span
              >
            </div>
          </div>
          <div class="chart-container">
            <canvas id="price-chart"></canvas>
          </div>
        </div>

        <!-- 卖家/库存趋势图 -->
        <div class="card chart-card">
          <div class="card-header">
            <h3>市场供应趋势</h3>
          </div>
          <div class="chart-container">
            <canvas id="supply-chart"></canvas>
          </div>
        </div>

        <!-- 价格分布分析 -->
        <div class="card">
          <div class="card-header">
            <h3>价格分析</h3>
          </div>
          <div class="analysis-content" id="analysis-content">
            <p class="loading">加载中...</p>
          </div>
        </div>

        <!-- 多维度分析 -->
        <div class="card">
          <div class="card-header">
            <h3>多维度数据分析</h3>
            <div class="analysis-tabs">
              <button class="tab-btn active" data-tab="daily">按天</button>
              <button class="tab-btn" data-tab="weekly">按周</button>
              <button class="tab-btn" data-tab="monthly">按月</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="analysis-chart"></canvas>
          </div>
          <div class="analysis-summary" id="analysis-summary">
            <!-- 动态生成统计摘要 -->
          </div>
        </div>

        <!-- 价格分布图 -->
        <div class="card">
          <div class="card-header">
            <h3>价格区间分布</h3>
          </div>
          <div class="chart-container" style="height: 250px">
            <canvas id="distribution-chart"></canvas>
          </div>
        </div>

        <!-- 数据记录表 -->
        <div class="card">
          <div class="card-header">
            <h3>采集记录</h3>
            <span class="record-count" id="record-count">0 条记录</span>
          </div>
          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>采集时间</th>
                  <th>最低价</th>
                  <th>平均价</th>
                  <th>最高价</th>
                  <th>卖家数</th>
                  <th>库存</th>
                </tr>
              </thead>
              <tbody id="data-table-body">
                <!-- 动态生成 -->
              </tbody>
            </table>
            <div class="pagination" id="pagination">
              <button class="btn btn-sm" onclick="prevPage()">上一页</button>
              <span class="page-info" id="page-info">第 1 页</span>
              <button class="btn btn-sm" onclick="nextPage()">下一页</button>
            </div>
          </div>
        </div>

        <!-- 页脚 -->
        <footer class="footer">
          <p>采集间隔：每10分钟</p>
        </footer>
      </main>
    </div>

    <!-- 添加游戏弹窗 -->
    <div class="modal" id="add-game-modal">
      <div class="modal-content">
        <h3>添加监控游戏</h3>
        <div class="form-group">
          <label>游戏ID</label>
          <input
            type="text"
            id="input-game-id"
            placeholder="输入游戏ID，如：461759890218553344"
          />
        </div>
        <div class="form-group">
          <label>游戏名称（可选）</label>
          <input type="text" id="input-game-name" placeholder="输入游戏名称" />
        </div>
        <div class="modal-actions">
          <button class="btn" onclick="hideAddGameModal()">取消</button>
          <button class="btn btn-primary" onclick="addGame()">添加</button>
        </div>
      </div>
    </div>

    <!-- 设置弹窗 -->
    <div class="modal" id="settings-modal">
      <div class="modal-content modal-lg">
        <h3>系统设置</h3>

        <!-- 标签导航 -->
        <div class="settings-tabs">
          <button
            class="settings-tab active"
            data-tab="basic"
            onclick="switchSettingsTab('basic')"
          >
            基础设置
          </button>
          <button
            class="settings-tab"
            data-tab="pushme"
            onclick="switchSettingsTab('pushme')"
          >
            推送设置
          </button>
          <button
            class="settings-tab"
            data-tab="games"
            onclick="switchSettingsTab('games')"
          >
            游戏管理
          </button>
          <button
            class="settings-tab"
            data-tab="database"
            onclick="switchSettingsTab('database')"
          >
            数据库
          </button>
        </div>

        <!-- 基础设置 -->
        <div class="settings-panel active" id="panel-basic">
          <div class="settings-section">
            <h4>采集配置</h4>
            <div class="form-group">
              <label>采集间隔（分钟）</label>
              <input
                type="number"
                id="input-interval"
                min="1"
                max="1440"
                value="10"
              />
              <small>范围：1-1440分钟（最长24小时）</small>
            </div>
            <div class="form-group">
              <label>数据保留天数</label>
              <input
                type="number"
                id="input-retention"
                min="1"
                max="365"
                value="365"
              />
              <small>范围：1-365天（最长一年）</small>
            </div>
          </div>
          <div class="settings-section">
            <h4>API 配置</h4>
            <div class="form-group">
              <label>Access Token</label>
              <input
                type="text"
                id="input-token"
                placeholder="输入新的 Access Token"
              />
              <small>当前：<span id="current-token">***</span></small>
            </div>
          </div>
        </div>

        <!-- 推送设置 -->
        <div class="settings-panel" id="panel-pushme">
          <div class="settings-section">
            <h4>PushMe 基础配置</h4>
            <div class="form-group">
              <label>
                <input type="checkbox" id="pushme-enabled" />
                启用 PushMe 推送
              </label>
            </div>
            <div class="form-group">
              <label>Push Key 管理（支持多个接收者）</label>
              <div id="pushme-keys-list" class="pushme-keys-list"></div>
              <div class="pushme-key-add">
                <input
                  type="text"
                  id="pushme-key-input"
                  placeholder="输入 Push Key"
                />
                <button class="btn btn-sm" onclick="addPushKey()">添加</button>
              </div>
              <small class="hint"
                >可添加多个 Push Key，消息将同时推送给所有接收者</small
              >
            </div>
          </div>

          <div class="settings-section">
            <h4>价格提醒规则</h4>
            <div class="form-group">
              <label>推送冷却时间（分钟）</label>
              <input
                type="number"
                id="pushme-cooldown"
                min="1"
                max="1440"
                value="60"
              />
              <small class="hint"
                >同一游戏触发提醒后，在此时间内不再重复推送</small
              >
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="pushme-history-low-alert" />
                史低提醒（价格达到/低于游戏设定的史低时推送）
              </label>
              <small class="hint"
                >需先在「游戏管理」中设置各游戏的史低价格</small
              >
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="pushme-price-change-alert" />
                价格变动提醒（涨跌幅）
              </label>
              <div class="sub-options">
                <div class="range-inputs">
                  <input
                    type="number"
                    id="pushme-drop-percent"
                    placeholder="跌幅%"
                    min="0"
                    max="100"
                  />
                  <span>跌</span>
                  <input
                    type="number"
                    id="pushme-rise-percent"
                    placeholder="涨幅%"
                    min="0"
                    max="100"
                  />
                  <span>涨</span>
                </div>
                <small>价格变动超过此百分比时推送（0表示不提醒）</small>
              </div>
            </div>
          </div>

          <div class="settings-section">
            <h4>其他提醒</h4>
            <div class="form-group">
              <label>
                <input type="checkbox" id="pushme-daily-report" />
                每日报告
              </label>
              <div class="sub-options">
                <input type="time" id="pushme-report-time" value="20:00" />
              </div>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="pushme-error-alert" checked />
                采集异常提醒
              </label>
            </div>
            <div style="margin-top: 15px">
              <button class="btn btn-sm" onclick="testPushMe()">
                测试推送
              </button>
              <button
                class="btn btn-sm"
                onclick="sendDailyReport()"
                style="margin-left: 5px"
              >
                发送报告
              </button>
            </div>
          </div>
        </div>

        <!-- 游戏管理 -->
        <div class="settings-panel" id="panel-games">
          <div class="settings-section">
            <h4>游戏史低价格设置</h4>
            <small
              style="
                color: var(--text-secondary);
                display: block;
                margin-bottom: 15px;
              "
            >
              设置每款游戏的史低价格，当价格低于史低时会特别标注
            </small>
            <div id="games-history-low-list">
              <!-- 动态生成 -->
              <p style="color: var(--text-secondary)">加载中...</p>
            </div>
          </div>
        </div>

        <!-- 数据库 -->
        <div class="settings-panel" id="panel-database">
          <div class="settings-section">
            <h4>数据库状态</h4>
            <div class="db-stats">
              <div class="db-stat-item">
                <span class="db-stat-label">记录总数</span>
                <span class="db-stat-value" id="db-record-count">--</span>
              </div>
              <div class="db-stat-item">
                <span class="db-stat-label">监控游戏</span>
                <span class="db-stat-value" id="db-game-count">--</span>
              </div>
              <div class="db-stat-item">
                <span class="db-stat-label">数据库大小</span>
                <span class="db-stat-value" id="db-size">--</span>
              </div>
              <div class="db-stat-item">
                <span class="db-stat-label">最早记录</span>
                <span class="db-stat-value" id="db-oldest">--</span>
              </div>
            </div>
            <button
              class="btn btn-sm btn-danger"
              onclick="cleanupData()"
              style="margin-top: 10px"
            >
              清理过期数据
            </button>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn" onclick="hideSettingsModal()">关闭</button>
          <button class="btn btn-primary" onclick="saveSettings()">
            保存设置
          </button>
        </div>
      </div>
    </div>

    <script src="app.js"></script>
  </body>
</html>
