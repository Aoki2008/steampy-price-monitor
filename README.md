# 🎮 Steam Key 价格监控系统 v2.0

实时监控 Steam Key 价格走势，支持多游戏监控、SQLite 数据存储、多维度数据分析和价格趋势图表展示。

## ✨ 功能特性

- 📊 **实时价格监控** - 自动采集最低价、平均价、最高价、卖家数、库存量
- 💾 **SQLite 数据存储** - 高性能数据库，支持最长一年数据保留
- ⚙️ **后台配置管理** - 可视化设置采集频率、数据保留期限、Access Token
- 📈 **多维度数据分析** - 按天/周/月分析、价格分布图、波动分析
- 🎯 **多游戏支持** - 同时监控多个游戏的价格走势，支持每游戏独立推送设置
- 💡 **智能建议** - 基于历史数据提供购买建议
- 🔔 **PushMe 推送提醒** - 支持史低提醒、每日报告、异常提醒，可配置多个接收者
- 🌓 **深色模式** - 支持亮色/暗色主题切换，保护眼睛
- 📱 **响应式设计** - 完美适配桌面端和移动端，移动端优化布局

## 🚀 快速开始

### 从 GitHub 克隆

```bash
# 克隆项目
git clone https://github.com/Aoki2008/steampy-price-monitor.git
cd steampy-price-monitor

# 安装依赖
npm install

# 启动服务
npm start
```

访问 **http://localhost:3000** 查看监控面板。

### 环境要求

- Node.js 16.0+
- npm 7.0+

---

## ⚙️ 后台配置

点击页面右上角的 **「⚙️ 设置」** 按钮，可以配置：

### 基础设置

#### 采集配置

| 配置项       | 范围        | 说明                     |
| ------------ | ----------- | ------------------------ |
| 采集间隔     | 1-1440 分钟 | 自动采集数据的时间间隔   |
| 数据保留天数 | 1-365 天    | 超过期限的数据会自动清理 |

#### API 配置

| 配置项       | 说明                               |
| ------------ | ---------------------------------- |
| Access Token | Steampy API 访问令牌，失效时可更新 |

### 推送设置

#### PushMe 基础配置

- **启用 PushMe 推送** - 总开关，控制所有推送功能
- **Push Key 管理** - 支持添加多个 Push Key，消息将同时推送给所有接收者
- **测试推送** - 发送测试消息验证推送配置

#### 价格提醒规则

| 配置项       | 范围        | 说明                                       |
| ------------ | ----------- | ------------------------------------------ |
| 推送冷却时间 | 1-1440 分钟 | 同一游戏触发提醒后，在此时间内不再重复推送 |
| 史低提醒     | 开/关       | 价格达到或低于游戏设定的史低时推送         |

#### 其他提醒

- **每日报告** - 设定时间自动发送每日价格汇总
- **采集异常提醒** - 数据采集失败时推送通知

### 游戏管理

为每个游戏单独配置：

| 配置项   | 说明                             |
| -------- | -------------------------------- |
| 史低价格 | 设置游戏的历史最低价，用于价格提醒 |
| 推送开关 | 是否为该游戏启用推送（独立控制）   |

### 数据库状态

- 记录总数、监控游戏数
- 数据库文件大小
- 最早记录时间
- 手动清理过期数据按钮

### 关于

- 项目版本信息
- 项目简介与主要功能
- 技术栈说明
- 项目 GitHub 地址
- 开源协议信息

---

## 📊 数据分析功能

### 价格走势图

- 最低价、平均价、最高价趋势线
- 支持 24 小时/7 天/30 天/全部 时间范围

### 市场供应趋势

- 卖家数量变化
- 库存总量变化

### 多维度分析

- **按天分析** - 最近 30 天每日价格统计
- **按周分析** - 最近 12 周每周价格统计
- **按月分析** - 最近 12 个月每月价格统计

### 价格分布

- 价格区间分布饼图 (0-5, 5-10, 10-20, 20-50, 50+)

### 统计指标

- 历史最低价/最高价/均价
- 价格波动幅度
- 购买建议

---

## 📁 项目结构

```
jiank/
├── server.js           # 后端服务器 (Express + SQLite)
├── package.json        # 项目依赖
├── README.md           # 项目文档
├── data/
│   ├── prices.db       # SQLite 数据库 (自动生成)
│   └── config.json     # 配置文件 (自动生成)
└── public/
    ├── index.html      # 前端页面
    ├── style.css       # 样式文件
    └── app.js          # 前端逻辑
```

---

## 🔌 API 接口

### 游戏管理

| 方法   | 路径                                 | 说明                                          |
| ------ | ------------------------------------ | --------------------------------------------- |
| GET    | `/api/games`                         | 获取所有监控游戏（含史低价格和推送设置）      |
| POST   | `/api/games`                         | 添加游戏 `{id, name}`                         |
| DELETE | `/api/games/:id`                     | 删除游戏及其数据                              |
| PUT    | `/api/games/:id/history-low`         | 更新游戏史低价格 `{history_low_price: number}` |
| PUT    | `/api/games/:id/push-settings`       | 更新游戏推送设置 `{push_enabled: boolean}`    |

### 价格数据

| 方法 | 路径                             | 说明               |
| ---- | -------------------------------- | ------------------ |
| GET  | `/api/prices/:gameId?period=day` | 获取价格历史       |
| GET  | `/api/stats/:gameId?period=day`  | 获取统计数据       |
| GET  | `/api/analysis/:gameId`          | 获取多维度分析数据 |

`period` 可选值：`day`（24 小时）、`week`（7 天）、`month`（30 天）、`quarter`（90 天）、`year`（365 天）、`all`（全部）

### 配置管理

| 方法 | 路径            | 说明                                                                                    |
| ---- | --------------- | --------------------------------------------------------------------------------------- |
| GET  | `/api/config`   | 获取当前配置（含 PushMe 配置）                                                          |
| PUT  | `/api/config`   | 更新配置 `{accessToken, collectInterval, dataRetentionDays, pushme: {...}}` |
| GET  | `/api/db-stats` | 获取数据库状态                                                                          |

### 采集控制

| 方法 | 路径                   | 说明             |
| ---- | ---------------------- | ---------------- |
| POST | `/api/collect`         | 手动采集所有游戏 |
| POST | `/api/collect/:gameId` | 手动采集指定游戏 |
| POST | `/api/cleanup`         | 清理过期数据     |

### PushMe 推送

| 方法 | 路径                        | 说明                                       |
| ---- | --------------------------- | ------------------------------------------ |
| POST | `/api/pushme/test`          | 测试推送 `{pushKeys: string[]}`            |
| POST | `/api/pushme/daily-report`  | 手动发送每日报告                           |

---

## 🎮 添加新游戏

### 方法一：网页操作

点击页面上的 **「+ 添加游戏」** 按钮，输入游戏 ID 和名称。

### 方法二：API 调用

```bash
curl -X POST http://localhost:3000/api/games \
  -H "Content-Type: application/json" \
  -d '{"id": "游戏ID", "name": "游戏名称"}'
```

### 如何获取游戏 ID？

从 Steampy APP 的游戏详情页 URL 或接口中获取 `gameId` 参数。

---

## ❓ 常见问题

### Q: 如何修改采集频率？

点击页面右上角「⚙️ 设置」按钮，修改「采集间隔」后保存即可，无需重启服务。

### Q: 数据文件太大怎么办？

1. 在设置中减少「数据保留天数」
2. 点击「🗑️ 清理过期数据」按钮

### Q: Access Token 失效怎么办？

1. 从 Steampy APP 抓包获取新的 Token
2. 在设置页面的「Access Token」输入框中填入新 Token
3. 点击「保存设置」

### Q: 如何后台运行？

```bash
# 使用 pm2 (推荐)
npm install -g pm2
pm2 start server.js --name "steam-monitor"
pm2 save

# 查看日志
pm2 logs steam-monitor

# 停止服务
pm2 stop steam-monitor
```

---

## 🛠️ 技术栈

- **后端**: Node.js + Express + node-cron
- **数据库**: SQLite (sql.js)
- **前端**: 原生 HTML/CSS/JS + Chart.js
- **图表**: Chart.js + chartjs-adapter-date-fns

---

## 📝 更新日志

### v2.1.1 (2025-12-16)

#### 新增功能
- ✨ 在设置窗口新增"关于"标签页
  - 显示项目版本信息（v2.1.0）
  - 展示项目简介与主要功能列表
  - 包含技术栈说明
  - 提供项目 GitHub 地址链接
  - 显示开源协议信息（MIT License）

#### 安全改进
- 🔒 修复外部链接安全问题，添加 `rel="noopener noreferrer"` 属性

### v2.1.0 (2025-12-16)

#### 安全修复
- 🔒 修复 XSS 跨站脚本漏洞（高优先级）
  - 添加 HTML 转义工具函数
  - 将所有 innerHTML 改为安全的 DOM API 操作
  - 修复游戏列表、设置列表、Push Key 列表的 XSS 漏洞

#### 新增功能
- 🔔 PushMe 推送通知系统
  - 支持史低价格提醒（可为每个游戏单独设置）
  - 支持每日报告（可自定义发送时间）
  - 支持采集异常提醒
  - 支持多个接收者（Push Key 管理）
  - 推送冷却机制，避免频繁打扰
- 🎮 游戏级推送开关（每个游戏可独立控制是否推送）
- 💰 游戏史低价格设置（支持自定义每个游戏的历史最低价）

#### UI/UX 改进
- 🌓 深色模式支持（亮色/暗色主题切换）
- 📱 移动端响应式优化
  - 优化导航栏布局，修复内容遮挡问题
  - 优化游戏管理标签页在移动端的显示
  - 使用 flexbox 改进元素间距和对齐
  - 优化字体大小和元素尺寸以适配小屏幕
- 🎨 设置面板标签化设计（基础设置/推送设置/游戏管理/数据库）

#### 错误处理改进
- ⚠️ 游戏推送设置保存失败时添加错误提示
- 📊 史低价格和推送设置保存的原子性改进
- 🔍 PushMe 测试推送和每日报告的详细错误信息

### v2.0.0

- ✨ 新增 SQLite 数据库存储，替换 JSON 文件
- ✨ 新增后台配置页面，支持可视化设置
- ✨ 新增 Access Token 在线更新功能
- ✨ 新增多维度数据分析（按天/周/月）
- ✨ 新增价格分布饼图
- ✨ 数据保留期限扩展至最长一年
- 🚀 性能优化，支持大量历史数据

### v1.0.0

- 🎉 初始版本，基础价格监控功能
